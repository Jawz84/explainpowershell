on:
  workflow_dispatch: 
  push:
    branches:
    - main
name: Deploy app to Azure
jobs:
  deployBackend:
    runs-on: windows-latest
    steps:
    - uses: actions/download-artifact@v4
      name: Download artifacts
      with:
        name: api
        path: backend_artifact
    - uses: azure/login@v2
      name: Authenticate with Azure
      with:
        creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL }}
    - name: Deploy Function App package
      shell: pwsh
      run: |
        az functionapp deployment source config-zip `
          --resource-group "${{ secrets.RESOURCE_GROUP_NAME }}".trim() `
          --name "${{ secrets.FUNCTION_APP_NAME }}".trim() `
          --src (Join-Path $PWD 'backend_artifact/functionapp.zip')
    - run: "az functionapp list |\n  ConvertFrom-Json |\n  where {$_.defaulthostname -match 'powershellexplainer' -and $_.state -eq 'running'} | \n  ForEach-Object { Invoke-RestMethod -Uri \"https://$($_.DefaultHostName)/api/MetaData?refresh=true\" }\n"
      name: Calculate new HelpMetaData
      shell: pwsh
    needs: buildBackend
    name: Deploy Backend api
  buildBackend:
    runs-on: windows-latest
    steps:
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "10.0"
    - uses: actions/checkout@v4
    - run: Get-ChildItem -Path ./explainpowershell.analysisservice/ -Recurse -Filter *_code_generator.ps1 | ForEach-Object { & $_.FullName }
      name: Run code generators
      shell: pwsh
    - run: |
        Set-Location ./explainpowershell.analysisservice
        dotnet publish --configuration Release
      name: Publish with dotnet
      shell: pwsh
    - name: Zip publish output
      shell: pwsh
      run: |
        $publishDir = Join-Path $PWD 'explainpowershell.analysisservice/bin/Release/net10.0/publish'
        $zipPath = Join-Path $PWD 'explainpowershell.analysisservice/bin/Release/net10.0/functionapp.zip'
        if (Test-Path $zipPath) {
          Remove-Item $zipPath -Force
        }
        $entries = Get-ChildItem -LiteralPath $publishDir -Force
        if (-not $entries) {
          throw "No publish output found at $publishDir"
        }
        Compress-Archive -Path $entries.FullName -DestinationPath $zipPath -Force
    - uses: actions/upload-artifact@v4
      name: Publish artifacts
      with:
        name: api
        path: ./explainpowershell.analysisservice/bin/Release/net10.0/functionapp.zip
    name: Build Backend api
  buildFrontend:
    runs-on: windows-latest
    steps:
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "10.0"
    - uses: actions/checkout@v4
    - run: |
        $uri = "https://$("${{ secrets.FUNCTION_APP_NAME }}".trim()).azurewebsites.net/api/"
        Set-Content -Path ./explainpowershell.frontend/wwwroot/appsettings.json -Value (@{BaseAddress = $uri} | ConvertTo-Json)
        Get-Content -path ./explainpowershell.frontend/wwwroot/appsettings.json
      name: Set api url to correct url manually
      shell: pwsh
    - run: Get-ChildItem -Path ./explainpowershell.frontend/ -Recurse -Filter *_code_generator.ps1 | ForEach-Object { & $_.FullName }
      name: Run code generators
      shell: pwsh
    - run: dotnet build --configuration Release explainpowershell.frontend
      name: Build with dotnet
    - run: dotnet publish --configuration Release explainpowershell.frontend
      name: Publish with dotnet
    - uses: actions/upload-artifact@v4
      name: Publish artifacts
      with:
        name: webapp
        path: ./explainpowershell.frontend/bin/Release/net10.0/publish/wwwroot
    name: Build Frontend
  deployFrontend:
    runs-on: windows-latest
    steps:
    - uses: actions/download-artifact@v4
      name: Download artifacts
      with:
        name: webapp
    - uses: azure/login@v2
      name: Authenticate with Azure
      with:
        creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL }}
    - run: "az storage blob delete-batch --account-name \"${{ secrets.STORAGE_ACCOUNT_NAME }}\".trim() --source `$web \n"
      name: Clean up previous deployment
      shell: pwsh
    - run: |
        az storage blob upload-batch --account-name "${{ secrets.STORAGE_ACCOUNT_NAME }}".trim() --source ./ --destination `$web
      name: Deploy to storage account
      shell: pwsh
    - run: |
        if ( -not [String]::IsNullOrEmpty("${{ secrets.AZURE_CDN_ENDPOINT }}".trim()) ) {
          az cdn endpoint purge -n "${{ secrets.AZURE_CDN_ENDPOINT }}".trim() --profile-name "${{ secrets.AZURE_CDN_ENDPOINT }}".trim() --content-paths "/*" --resource-group "${{ secrets.RESOURCE_GROUP_NAME }}".trim()
          "Az CDN endpoint purged"
        }
      name: Purge Azure CDN
      shell: pwsh
    needs: buildFrontend
    name: Deploy Frontend

