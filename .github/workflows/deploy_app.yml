name: Deploy Explain PowerShell app to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP_NAME: explainpowershelltest
  BLOB_STORAGE_ACCOUNT_NAME: explainpowershelltest
  FUNCTION_APP_NAME: explainpowershellsyntaxanalyzertest

jobs:
  buildFrontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Set api url to correct url manually
      shell: pwsh
      run: |
          $uri = "https://${{ env.FUNCTION_APP_NAME }}.azurewebsites.net/api/"
          Set-Content -Path ./explainpowershell.frontend/wwwroot/appsettings.json -Value (@{BaseAddress = $uri} | ConvertTo-Json)
          Get-Content -path ./explainpowershell.frontend/wwwroot/appsettings.json

    - name: Build with dotnet
      run: dotnet build --configuration Release explainpowershell.frontend

    - name: Publish with dotnet
      run: dotnet publish --configuration Release explainpowershell.frontend

    - name: Publish artifacts
      uses: actions/upload-artifact@master
      with:
        name: webapp
        path: ./explainpowershell.frontend/bin/Release/net5.0/publish/wwwroot

  deployFrontend:
    needs: buildFrontend
    name: Deploy Frontend
    runs-on: ubuntu-latest
    steps:

    - name: Download artifacts
      uses: actions/download-artifact@master
      with:
        name: webapp

    - name: Authenticate with Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL_TEST }}

    - name: Clean up previous deployment
      shell: pwsh
      run: |
          az storage blob delete-batch --account-name ${{ env.BLOB_STORAGE_ACCOUNT_NAME }} --source `$web 

    - name: Deploy to storage account
      shell: pwsh
      run: |
          az storage blob upload-batch --account-name ${{ env.BLOB_STORAGE_ACCOUNT_NAME }} --source ./ --destination `$web

  buildBackend:
    name: Build Backend api
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Build with dotnet
        shell: pwsh
        run: |
          Set-Location ./explainpowershell.analysisservice
          dotnet build --configuration Release 

      - name: Publish artifacts
        uses: actions/upload-artifact@master
        with:
          name: api
          path: ./explainpowershell.analysisservice/bin/Release/netcoreapp3.1

  deployBackend:
    needs: buildBackend
    name: Deploy Backend api
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@master
        with:
          name: api

      - name: Authenticate with Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL_TEST }}

      - name: Get functionapp publish profile
        id: publishprofile
        shell: pwsh
        run: |
          $json = az functionapp deployment list-publishing-profiles --name ${{ env.FUNCTION_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP_NAME }}
          $funcProfile = $(
              "<publishData>"
              foreach ($publishProfile in ($json | ConvertFrom-Json)) {
                  "<publishProfile "
                  foreach ($prop in $publishProfile.psobject.Properties | where name -ne databases) {
                      "$($prop.Name)=`"$($prop.Value)`" "
                  }
                  "><databases /></publishProfile>"
              }
              "</publishData>"
          ) -join ''

          ##Write-Output "::add-mask::$funcProfile"
          write-output $funcProfile
          Write-Output "::set-output name=profile::$funcProfile"

      - name: 'Run Azure Functions Action'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: ./
          publish-profile: ${{ steps.publishprofile.outputs.profile }}