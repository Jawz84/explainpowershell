# Usage:
# 
# Save the functionapp publish profile to GitHub secrets under the name 'AZURE_FUNCTIONAPP_PUBLISH_PROFILE'.

name: Deploy Explain PowerShell app to Azure

on: 
  push:
    branch: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: explainpowershelltest
  BLOB_STORAGE_ACCOUNT_NAME: explainpowershelltest
  AZURE_FUNCTIONAPP_NAME: explainpowershellsyntaxanalyzertest
  AZURE_FUNCTIONAPP_PACKAGE_PATH: ./explainpowershell.analysisservice

jobs:
  buildFrontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Set api url to correct url manually
      shell: pwsh
      run: |
          $uri = "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/"
          Set-Content -Path ./explainpowershell.frontend/wwwroot/appsettings.json -Value (@{BaseAddress = $uri} | ConvertTo-Json)
          Get-Content -path ./explainpowershell.frontend/wwwroot/appsettings.json

    - name: Build with dotnet
      run: dotnet build --configuration Release explainpowershell.frontend

    - name: Publish with dotnet
      run: dotnet publish --configuration Release explainpowershell.frontend

    - name: Publish artifacts
      uses: actions/upload-artifact@master
      with:
        name: webapp
        path: ./explainpowershell.frontend/bin/Release/net5.0/publish/wwwroot

  deployFrontend:
    needs: buildFrontend
    name: Deploy Frontend
    runs-on: ubuntu-latest
    steps:

    - name: Download artifacts
      uses: actions/download-artifact@master
      with:
        name: webapp

    - name: Authenticate with Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_SERVICE_PRINCIPAL_TEST  }}

    - name: Clean up previous deployment
      shell: pwsh
      run: |
          az storage blob delete-batch --account-name ${{ env.BLOB_STORAGE_ACCOUNT_NAME }} --source `$web 

    - name: Deploy to storage account
      shell: pwsh
      run: |
          az storage blob upload-batch --account-name ${{ env.BLOB_STORAGE_ACCOUNT_NAME }} --source ./ --destination `$web

  buildBackend:
    name: Build Backend api
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Build with dotnet
        shell: pwsh
        run: |
          Set-Location ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          dotnet build --configuration Release 

      - name: Publish artifacts
        uses: actions/upload-artifact@master
        with:
          name: api
          path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/bin/Release/netcoreapp3.1

  deployBackend:
    needs: buildBackend
    name: Deploy Backend api
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@master
        with:
          name: api

      - name: 'Run Azure Functions Action'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ./
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}