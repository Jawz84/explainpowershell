@using System.Text.Json
@page "/"
@inject HttpClient Http

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16">
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-10">
        <MudText Typo="Typo.h3" GutterBottom="true">Explain PowerShell</MudText>
        <MudText Class="mb-4">Get explanation for PowerShell code oneliner</MudText>
        <MudCard Elevation="2">
            <MudForm>
                <MudCardContent>
                    <MudTextField @bind-Value="InputValue" Immediate="true" T="string" Label="PowerShell oneliner to analyze" AutoFocus="true" />
                    @if (requestHasError) {<MudAlert class="mt-2" OnClick="@acknowledgeAlert" Severity="Severity.Error">@reasonPhrase</MudAlert>}
                </MudCardContent>
                <MudCardActions>
                    @if (waiting)
                    {
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="ml-auto"/>
                    }
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@DoSearch" Disabled="@waiting" >Submit</MudButton>
                </MudCardActions>
            </MudForm>
        </MudCard>
    </MudContainer>
    <MudDivider DividerType="DividerType.Middle" Class="my-6" hidden="@hideExpandedCode"/>
    <MudText Align="Align.Center" hidden="@hideExpandedCode">@expandedCode</MudText>
    <MudDivider DividerType="DividerType.Middle" Class="my-6" hidden="@hasNoExplanations"/>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudTreeView Items="TreeItems">
            <ItemTemplate>
                <MudTreeViewItem @bind-Expanded="@context.IsExpanded" Items="@context.Children" >
                    <Content>
                        <MudTreeViewItemToggleButton @bind-Expanded="@context.IsExpanded" Visible="@context.HasChildren" /> 
                        @if(!string.IsNullOrEmpty(@context.Item.HelpResult?.Syntax)) 
                        {
                            @code {
                                private bool syntaxPopoverIsOpen;
                            }
                            <ExplainCard Context="@context.Item" />
                            <MudButton OnClick="@(() => syntaxPopoverIsOpen = true)">Syntax</MudButton>
                            <MudPopover Direction="Direction.Bottom" Open="@syntaxPopoverIsOpen">
                                @foreach (var line in @context.Item.HelpResult?.Syntax.Split("\n")) {
                                    @foreach (var param in line.Replace("] [","]\n[").Replace("[-", "\n[-").Replace(" -","\n-").Replace("[\n","[").Split("\n")) {
                                        <MudText>@param</MudText>
                                    }
                                }
                                <MudButton OnClick="@(() => syntaxPopoverIsOpen = false)">Ok</MudButton>
                            </MudPopover>
                        }
                        else
                        {
                            <ExplainCard Context="@context.Item" />
                        }
                    </Content>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>
    </MudContainer>
</MudContainer>

@code {
    private bool requestHasError {get;set;}
    private string reasonPhrase {get;set;}
    private bool waiting {get;set;}
    private bool hideExpandedCode {get;set;}
    private string expandedCode {get; set;}
    private HashSet<TreeItem<Explanation>> TreeItems { get; set; } = new HashSet<TreeItem<Explanation>>();
    private bool hasNoExplanations {
        get {
            return TreeItems.Count <= 0;
        }
    }
    private string InputValue {
        get {
            return _inputValue;
        }
        set {
            // The MudTextField can be overloaded with large amounts of text. Prevent this with a hard string length limit.
            if (value.Length <= 255)
                _inputValue = value;
        }
    }

    private void acknowledgeAlert() {
        requestHasError = false;
        reasonPhrase = "";
    }

    protected override Task OnInitializedAsync()
    {
        _ = DoSearch();
        return Task.FromResult("");
    }

    private async Task DoSearch()
    {
        hideExpandedCode = true;
        waiting = false;
        requestHasError = false;
        reasonPhrase = string.Empty;

        if (string.IsNullOrEmpty(InputValue))
            return;

        waiting = true;
        var code = new Code() { PowershellCode = InputValue };

        HttpResponseMessage temp;
        try {
            temp = await Http.PostAsJsonAsync<Code>("SyntaxAnalyzer", code);
        }
        catch {
            requestHasError = true;
            waiting = false;
            reasonPhrase = "oops!";
            return;
        }

        if (!temp.IsSuccessStatusCode) 
        {
            requestHasError = true;
            waiting = false;
            reasonPhrase = await temp.Content.ReadAsStringAsync();
            return;
        }

        var analysisResult = await JsonSerializer.DeserializeAsync<AnalysisResult>(temp.Content.ReadAsStream());

        if (!string.IsNullOrEmpty(analysisResult.ParseErrorMessage))
        {
            requestHasError = true;
            reasonPhrase = analysisResult.ParseErrorMessage;
        }

        waiting = false;
        hideExpandedCode = false;

        TreeItems = analysisResult.Explanations.GenerateTree(expl => expl.Id, expl => expl.ParentId);
        expandedCode = analysisResult.ExpandedCode;
    }

    private string _inputValue;
}
