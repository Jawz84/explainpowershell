@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.Text.Json;
@page "/"
@inject HttpClient Http

<MudGrid Justify="Justify.FlexEnd">
    <MudHidden IsHidden="@hasMetaData">
        <MudItem>
            <MudText Typo="Typo.caption" >Warming up backend.. </MudText>
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="ml-auto"/>
        </MudItem>
    </MudHidden>
    <MudHidden IsHidden="@notHasMetaData">
        <MudItem>
            <MudTooltip Text="MetaData" Placement="Placement.Start">
                <MudIconButton ButtonType="ButtonType.Button" Icon="@Icons.Material.Filled.InfoOutline" OnClick="@(() => OpenDrawer(Anchor.Right))" ></MudIconButton>
            </MudTooltip>
            <MudDrawer @bind-Open="@open" Anchor="@anchor" Elevation="1" Variant="@DrawerVariant.Temporary">
                <MudDrawerHeader>
                    <MudText Typo="Typo.h6">MetaData</MudText>
                </MudDrawerHeader>

                <MudGrid Spacing="1" Class="ma-1">
                    <MudItem>
                        <MudText Typo="Typo.caption"><b>Last published: </b></MudText>
                        <MudText Typo="Typo.caption">@metaData2?.LastPublished</MudText>
                    </MudItem>
                    <MudItem>
                        <MudText Typo="Typo.caption"><b>Number of commands: </b></MudText>
                        <MudText Typo="Typo.caption">@metaData2?.NumberOfCommands.ToString()</MudText>
                    </MudItem>
                    <MudItem>
                        <MudText Typo="Typo.caption"><b>Number of about-articles: </b></MudText>
                        <MudText Typo="Typo.caption">@metaData2?.NumberOfAboutArticles.ToString()</MudText>
                    </MudItem>
                    <MudItem>
                        <MudText Typo="Typo.caption"><b>Number of modules: </b></MudText>
                        <MudText Typo="Typo.caption">@metaData2?.NumberOfModules.ToString()</MudText>
                    </MudItem>
                    <MudItem>
                        <MudText Typo="Typo.caption"><b>Module names: </b></MudText>
                        <MudSelect T="string" Dense="true" MaxHeight="600" HelperText="Module names..">
                            @if(metaData2 != null) {
                                @foreach (var mod in metaData2?.ModuleNames.OrderBy(name => name))
                                {
                                    <MudSelectItem T="string" Value="@mod">@mod</MudSelectItem>
                                }
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudDrawer>
        </MudItem>
    </MudHidden>
</MudGrid>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16">
    <MudText Typo="Typo.h3" GutterBottom="true">Explain PowerShell</MudText>
    <MudText Class="mb-4">Get explanation for PowerShell code oneliner</MudText>

    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-10">
        <MudCard Elevation="2">
            <MudForm>
                <MudCardContent>
                    <MudTextField @bind-Value="InputValue" Immediate="true" T="string" Label="PowerShell oneliner to analyze" AutoFocus="true" />
                    @if (requestHasError) {<MudAlert class="mt-2" OnClick="@acknowledgeAlert" Severity="Severity.Error">@reasonPhrase</MudAlert>}
                </MudCardContent>
                <MudCardActions>
                    @if (waiting)
                    {
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="ml-auto"/>
                    }
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@DoSearch" Disabled="@waiting" >Submit</MudButton>
                </MudCardActions>
            </MudForm>
        </MudCard>
    </MudContainer>
    <MudDivider DividerType="DividerType.Middle" Class="my-6" hidden="@hideExpandedCode"/>
    <MudText Align="Align.Center" hidden="@hideExpandedCode">@expandedCode</MudText>
    <MudDivider DividerType="DividerType.Middle" Class="my-6" hidden="@hasNoExplanations"/>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudTreeView Items="TreeItems">
            <ItemTemplate>
                <MudTreeViewItem @bind-Expanded="@context.IsExpanded" Items="@context.Children" >
                    <Content>
                        <MudTreeViewItemToggleButton @bind-Expanded="@context.IsExpanded" Visible="@context.HasChildren" /> 
                        <MudCard Class="mb-2 px-3 py-2" Elevation="2" >
                            <MudText Typo="Typo.h6" >@context.Item.OriginalExtent</MudText>
                            <MudText>@if(@context.Item.HelpResult != null) 
                                {
                                    <MudLink Href="@context.Item.HelpResult?.DocumentationLink" Target="_blank">@context.Item.CommandName</MudLink>
                                }
                                else {
                                    @context.Item.CommandName
                                }
                            </MudText>
                            <MudText>@context.Item.Description</MudText>
                            @if(! string.IsNullOrEmpty(@context.Item.HelpResult?.ModuleName)) {
                                <MudText><b>Module:</b> @context.Item.HelpResult?.ModuleName</MudText>
                            }
                        </MudCard>
                    </Content>
                </MudTreeViewItem>
            </ItemTemplate>
        </MudTreeView>
    </MudContainer>
</MudContainer>

@code {
    private bool requestHasError {get;set;}
    private bool hasMetaData {get;set;}
    private bool notHasMetaData => ! hasMetaData;
    private string reasonPhrase {get;set;}
    private bool waiting {get;set;}
    private bool hideExpandedCode {get;set;}
    private string expandedCode {get; set;}
    private HelpMetaData metaData2 {get; set;}
    private HashSet<TreeItem<Explanation>> TreeItems { get; set; } = new HashSet<TreeItem<Explanation>>();
    private bool hasNoExplanations {
        get {
            return TreeItems.Count <= 0;
        }
    }
    private string InputValue {
        get {
            return _inputValue;
        }
        set {
            // The web page can be overloaded with large amounts of text. prevent this with a hard string length limit.
            if (value.Length <= 255)
                _inputValue = value;
        }
    }

    private void acknowledgeAlert() {
        requestHasError = false;
        reasonPhrase = "";
    }

    protected override async Task OnInitializedAsync()
    {
        _ = DoSearch();

        try {
            metaData2 = await Http.GetFromJsonAsync<HelpMetaData>("MetaData");
            hasMetaData = true;
            StateHasChanged();
        }
        catch {
            requestHasError = true;
            waiting = false;
            reasonPhrase = "oops!";
            return;
        }
    }

    private void OpenDrawer(Anchor anchor)
    {
        open = true;
        this.anchor = anchor;
    }
    private async Task DoSearch()
    {
        hideExpandedCode = true;
        waiting = false;
        requestHasError = false;
        reasonPhrase = string.Empty;

        if (string.IsNullOrEmpty(InputValue))
            return;

        waiting = true;
        var code = new Code() { PowershellCode = InputValue };

        HttpResponseMessage temp;
        try {
            temp = await Http.PostAsJsonAsync<Code>("SyntaxAnalyzer", code);
        }
        catch {
            requestHasError = true;
            waiting = false;
            reasonPhrase = "oops!";
            return;
        }

        if (!temp.IsSuccessStatusCode) 
        {
            requestHasError = true;
            waiting = false;
            reasonPhrase = await temp.Content.ReadAsStringAsync();
            return;
        }

        var analysisResult = await JsonSerializer.DeserializeAsync<AnalysisResult>(temp.Content.ReadAsStream());

        if (!string.IsNullOrEmpty(analysisResult.ParseErrorMessage))
        {
            requestHasError = true;
            reasonPhrase = analysisResult.ParseErrorMessage;
        }

        waiting = false;
        hideExpandedCode = false;

        TreeItems = analysisResult.Explanations.GenerateTree(expl => expl.Id, expl => expl.ParentId);
        expandedCode = analysisResult.ExpandedCode;
    }

    private string _inputValue;
    bool open;
    Anchor anchor;
}
